# 用户认证功能规范

> **Branch**: `feature/user-auth`  
> **Spec Path**: `specs/user-auth/`  
> **Created**: 2026-01-01  
> **Status**: Draft

---

## Overview

提供完整的用户认证功能，包括手机号注册、登录认证、密码管理和登录历史记录，确保用户账户安全和操作可追溯。

---

## User Stories

### Story 1: 用户注册 (P1)

AS a 新用户
I WANT 使用手机号和密码注册账户
SO THAT 可以使用系统的各项功能

**独立测试**: 用户成功提交手机号、密码和短信验证码后，系统创建账户并返回用户ID

### Story 2: 用户登录 (P1)

AS a 已注册用户
I WANT 使用手机号和密码登录系统
SO THAT 获得访问权限并使用系统功能

**独立测试**: 用户使用正确的手机号和密码登录后，系统返回JWT Token

### Story 3: 忘记密码重置 (P2)

AS a 忘记密码的用户
I WANT 通过手机号和短信验证码重置密码
SO THAT 可以重新获得账户访问权限

**独立测试**: 用户提交手机号、短信验证码和新密码后，系统更新密码并允许登录

### Story 4: 登录历史记录 (P2)

AS a 用户或管理员
I WANT 查看登录历史记录
SO THAT 了解账户安全状况和登录活动

**独立测试**: 用户或管理员可以查询登录历史记录，包括登录时间、IP地址、设备信息等

---

## Acceptance Criteria (EARS)

### 正常流程

| ID | Scenario | Trigger | Expected Behavior |
|----|----------|---------|-------------------|
| AC-01 | 发送注册验证码成功 | WHEN 用户提交有效的手机号 | THE SYSTEM SHALL 发送短信验证码到该手机号并返回成功状态 |
| AC-02 | 用户注册成功 | WHEN 用户提交有效的手机号、密码和正确的短信验证码 | THE SYSTEM SHALL 创建用户账户，密码加密存储，并返回201状态码和用户ID |
| AC-03 | 用户登录成功 | WHEN 用户提交正确的手机号和密码 | THE SYSTEM SHALL 验证密码，生成JWT Token，记录登录历史，并返回200状态码和Token |
| AC-04 | 发送密码重置验证码成功 | WHEN 用户提交有效的手机号请求重置密码 | THE SYSTEM SHALL 发送短信验证码到该手机号并返回成功状态 |
| AC-05 | 密码重置成功 | WHEN 用户提交有效的手机号、正确的短信验证码和新密码 | THE SYSTEM SHALL 更新密码（加密存储），并返回200状态码 |
| AC-06 | 查询登录历史成功 | WHEN 用户查询自己的登录历史 | THE SYSTEM SHALL 返回该用户的登录历史记录列表（包含时间、IP、设备等信息） |

### 异常处理

| ID | Scenario | Trigger | Expected Behavior |
|----|----------|---------|-------------------|
| AC-10 | 手机号格式无效 | WHEN 用户提交的手机号格式不正确 | THE SYSTEM SHALL 返回400错误和"手机号格式不正确"的错误信息 |
| AC-11 | 手机号已注册 | WHEN 用户尝试使用已注册的手机号注册 | THE SYSTEM SHALL 返回409错误和"该手机号已注册"的错误信息 |
| AC-12 | 短信验证码错误 | WHEN 用户提交的短信验证码不正确 | THE SYSTEM SHALL 返回400错误和"验证码错误"的错误信息 |
| AC-13 | 短信验证码过期 | WHEN 用户提交已过期的短信验证码 | THE SYSTEM SHALL 返回400错误和"验证码已过期，请重新获取"的错误信息 |
| AC-14 | 密码强度不足 | WHEN 用户提交的密码不符合强度要求 | THE SYSTEM SHALL 返回400错误和"密码强度不足"的错误信息，并告知密码规则（必须包含数字、大写字母、小写字母和特殊字符） |
| AC-15 | 登录失败-手机号不存在 | WHEN 用户使用未注册的手机号登录 | THE SYSTEM SHALL 返回401错误和"手机号或密码错误"的错误信息（不暴露具体是手机号还是密码错误） |
| AC-16 | 登录失败-密码错误 | WHEN 用户使用错误的密码登录 | THE SYSTEM SHALL 返回401错误和"手机号或密码错误"的错误信息 |
| AC-17 | 密码重置-手机号不存在 | WHEN 用户使用未注册的手机号请求重置密码 | THE SYSTEM SHALL 返回404错误和"该手机号未注册"的错误信息 |
| AC-18 | 密码重置-新密码与旧密码相同 | WHEN 用户提交的新密码与当前密码相同 | THE SYSTEM SHALL 返回400错误和"新密码不能与当前密码相同"的错误信息 |
| AC-19 | 登录历史-无权限 | WHEN 用户尝试查询其他用户的登录历史 | THE SYSTEM SHALL 返回403错误和"无权访问"的错误信息 |
| AC-20 | 登录失败-账户状态异常 | WHEN 用户登录时账户状态不是"启用"（禁用或锁定） | THE SYSTEM SHALL 返回403错误和"当前用户存在异常，请联系管理员"的错误信息 |
| AC-21 | 密码重置后Token失效 | WHEN 用户密码重置成功后使用旧Token访问系统 | THE SYSTEM SHALL 返回401错误和"Token已失效，请重新登录"的错误信息 |

---

## Edge Cases

| ID | Case | Expected Behavior |
|----|------|-------------------|
| EC-01 | 同一手机号在验证码有效期内多次请求 | 每次请求都发送新的验证码，旧的验证码失效 |
| EC-02 | 用户注册后立即登录 | 允许用户注册成功后立即使用新密码登录 |
| EC-03 | 用户在密码重置过程中使用旧密码登录 | 如果密码已重置，旧密码失效，所有旧Token立即失效；如果尚未重置，旧密码仍然有效 |
| EC-04 | 并发登录同一账户 | 允许多设备同时登录，每次登录都生成新的Token并记录登录历史 |
| EC-09 | 密码重置后立即使用旧Token | 密码重置成功后，用户的所有旧Token立即失效，使用旧Token的请求返回401错误 |
| EC-05 | 登录历史记录达到上限 | 保留最近N条记录，删除更早的记录（具体数量在业务规则中定义） |
| EC-06 | 验证码发送失败（短信服务异常） | 返回500错误和"验证码发送失败，请稍后重试"的错误信息 |
| EC-07 | JWT Token生成失败 | 返回500错误和"登录失败，请稍后重试"的错误信息 |
| EC-08 | 用户在验证码有效期内重复注册 | 返回409错误和"该手机号已注册"的错误信息（检查手机号是否已存在） |

---

## Business Rules

| ID | Rule | Description |
|----|------|-------------|
| BR-01 | 手机号唯一性 | 每个手机号只能注册一个账户 |
| BR-02 | 手机号格式 | 手机号必须是11位数字，以1开头 |
| BR-03 | 短信验证码有效期 | 短信验证码有效期为5分钟 |
| BR-04 | 短信验证码长度 | 短信验证码为6位数字 |
| BR-05 | 短信验证码使用限制 | 每个验证码只能使用一次，使用后立即失效 |
| BR-06 | 短信验证码发送频率 | 同一手机号60秒内只能发送一次验证码 |
| BR-07 | 密码长度要求 | 密码长度必须在8-32个字符之间 |
| BR-08 | 密码复杂度要求 | 密码必须包含至少数字、大写字母、小写字母和特殊字符 |
| BR-09 | 密码加密存储 | 密码必须使用加密算法（如bcrypt）存储，不能明文保存 |
| BR-10 | JWT Token有效期 | JWT Token有效期为7天 |
| BR-11 | 登录历史保留时间 | 登录历史记录保留90天，超过90天的记录自动清理 |
| BR-12 | 登录历史记录上限 | 每个用户最多保留最近1000条登录历史记录 |
| BR-13 | 登录历史记录内容 | 每次登录必须记录：登录时间、IP地址、设备类型、设备标识（如User-Agent） |
| BR-14 | 密码重置后旧Token失效 | 密码重置后，该用户的所有旧JWT Token立即失效，需要重新登录 |
| BR-15 | 验证码发送接口独立性 | 验证码发送是独立的API接口，用户需要先调用发送接口，再调用注册/重置接口 |
| BR-16 | 注册接口参数 | 注册接口必须接收手机号、密码和短信验证码三个参数 |
| BR-17 | 密码重置流程 | 密码重置采用双接口流程：先调用"请求重置密码"接口发送验证码，再调用"确认重置密码"接口验证并更新密码 |
| BR-18 | 密码重置后登录要求 | 密码重置成功后，用户必须使用新密码重新登录，不能继续使用旧Token |
| BR-19 | 账户状态类型 | 账户状态包括：启用、禁用、锁定三种状态 |
| BR-20 | 账户状态初始值 | 新注册用户的账户状态初始值为"启用" |
| BR-21 | 账户禁用规则 | 账户禁用由管理员手动操作，禁用后账户无法登录 |
| BR-22 | 账户锁定规则 | 账户锁定由系统自动触发（如连续登录失败），锁定后账户无法登录 |
| BR-23 | 账户解锁规则 | 账户被锁定后，需要管理员手动解锁 |

---

## Data Considerations

| Field | Description | Constraints |
|-------|-------------|-------------|
| 用户ID | 用户唯一标识 | 系统生成，唯一，不可修改 |
| 手机号 | 用户手机号码 | 必填，11位数字，唯一，不可修改 |
| 密码哈希 | 加密后的密码 | 必填，加密存储，不可明文 |
| 注册时间 | 用户注册时间 | 系统自动记录 |
| 最后登录时间 | 最后一次登录时间 | 每次登录时更新 |
| 账户状态 | 账户状态（启用/禁用/锁定） | 默认启用，禁用由管理员手动操作，锁定由系统自动触发 |
| 账户锁定时间 | 账户被锁定的时间戳 | 系统自动记录，用于解锁判断 |
| 账户锁定原因 | 账户被锁定的原因 | 如"连续登录失败"等 |
| 短信验证码 | 验证码内容 | 6位数字，5分钟有效期，一次性使用 |
| 验证码类型 | 验证码类型（注册/重置密码） | 用于区分不同场景的验证码 |
| 验证码发送时间 | 验证码发送时间戳 | 用于计算有效期 |
| 验证码使用状态 | 验证码是否已使用 | 默认未使用，使用后标记为已使用 |
| JWT Token | 认证令牌 | 包含用户ID、过期时间等信息 |
| Token过期时间 | Token的过期时间戳 | 7天有效期 |
| 登录历史ID | 登录记录唯一标识 | 系统生成 |
| 登录用户ID | 登录的用户ID | 关联用户表 |
| 登录IP | 登录时的IP地址 | IPv4或IPv6格式 |
| 登录设备类型 | 设备类型（Web/Android/iOS等） | 从User-Agent解析 |
| 登录设备标识 | 设备唯一标识 | 如设备ID、浏览器指纹等 |
| 登录时间 | 登录时间戳 | 精确到秒 |

---

## Success Metrics

| ID | Metric | Target |
|----|--------|--------|
| SC-01 | 注册接口响应时间 | < 300ms (P99) |
| SC-02 | 登录接口响应时间 | < 200ms (P99) |
| SC-03 | 短信验证码发送成功率 | > 99% |
| SC-04 | 密码加密性能 | 单次加密 < 100ms |
| SC-05 | 测试覆盖率 | > 80% |
| SC-06 | 并发登录支持 | 支持1000并发登录请求 |

---

## Open Questions

- [ ] 短信验证码服务提供商是哪家？需要集成具体的短信服务API吗？
- [ ] JWT Token的签名密钥存储在哪里？是否需要支持密钥轮换？
- [ ] 是否需要支持"记住我"功能（延长Token有效期）？
- [ ] 密码重置是否需要支持通过邮箱验证？
- [ ] 账户锁定机制的具体规则是什么（连续失败多少次后锁定？锁定多长时间？）？
- [ ] 登录历史记录查询是否需要支持分页和筛选（按时间范围、IP地址等）？
- [ ] 管理员是否有权限查看所有用户的登录历史？
- [ ] 是否需要支持第三方登录（微信、支付宝等）？
- [ ] 短信验证码发送是否需要限制每日发送次数（防止恶意刷取）？

---

## Revision History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2025-01-01 | - | 初始版本 |
| 1.1 | 2026-01-01 | - | 澄清并更新：验证码流程、账户状态管理、密码强度规则 |


# 用户认证功能规范 - 澄清报告

> **生成时间**: 2026-01-01  
> **规范版本**: 1.0 → 1.1  
> **状态**: 部分已解决

---

## 1. Requirements Clarification（需求澄清）

### 🔍 问题 1: 验证码发送流程不明确 ✅ 已解决

**位置**: AC-01, AC-04

**解决方案**: 验证码发送是独立接口。注册流程是先发送验证码，再调用注册接口。

**问题描述**: 
- AC-01 和 AC-04 分别描述了"发送注册验证码"和"发送密码重置验证码"，但没有明确说明：
  1. 这是独立的API接口，还是注册/重置流程的第一步？
  2. 用户是否需要先调用发送验证码接口，再调用注册/重置接口？
  3. 注册和密码重置的验证码是否可以复用同一接口（通过参数区分）？

**可能的解释**:
- **方案A**: 验证码发送是独立接口，用户需要先调用发送接口，再调用注册/重置接口
- **方案B**: 验证码发送集成在注册/重置接口中，系统自动发送
- **方案C**: 有独立的发送接口，但在注册/重置时也可以触发发送

**建议问题**:
1. 验证码发送是否需要独立的API接口？
2. 注册流程：是先调用"发送验证码"接口，再调用"注册"接口？还是注册接口内部自动发送验证码？
3. 密码重置流程：是否需要"请求重置密码"接口先发送验证码，然后"确认重置密码"接口验证并更新？

---

### 🔍 问题 2: 注册流程的完整性 ✅ 已解决

**位置**: AC-01, AC-02

**解决方案**: 注册接口需要包含验证码这个参数。注册流程：先调用发送验证码接口，再调用注册接口（包含手机号、密码、验证码）。

**问题描述**:
- AC-01 描述了发送验证码，AC-02 描述了注册成功，但没有明确：
  1. 注册接口是否需要同时接收手机号、密码、验证码三个参数？
  2. 还是注册接口只接收手机号和密码，验证码在其他步骤验证？
  3. 如果验证码错误，注册接口应该返回什么错误？

**可能的解释**:
- **方案A**: 注册接口接收（手机号、密码、验证码），在接口内验证验证码
- **方案B**: 验证码验证和注册是分离的，注册时只需手机号和密码


**建议问题**:
1. 注册接口的请求参数是什么？是否包含验证码字段？
2. 验证码验证是在注册接口内部完成，还是由单独的接口完成？

---

### 🔍 问题 3: 密码重置流程的完整性 ✅ 已解决

**位置**: AC-04, AC-05, BR-14

**解决方案**: 密码重置是双接口流程。成功后，需要用户重新登录；密码重置后Token立即失效。

**问题描述**:
- AC-04 描述了发送验证码，AC-05 描述了重置密码，BR-14 说明了重置后Token失效，但流程不完整：
  1. 密码重置是否需要两个接口：先"请求重置"（发送验证码），再"确认重置"（验证码+新密码）？
  2. 还是只有一个"重置密码"接口，内部先发送验证码再验证？
  3. 密码重置成功后，是否需要返回新的Token，还是要求用户重新登录？

**可能的解释**:
- **方案A**: 两个接口：`POST /api/v1/auth/reset-password/request`（发送验证码）和 `POST /api/v1/auth/reset-password/confirm`（验证码+新密码）
- **方案B**: 一个接口：`POST /api/v1/auth/reset-password`，内部处理验证码发送和验证

**建议问题**:
1. 密码重置是单接口还是双接口流程？
2. 密码重置成功后，用户是否需要重新登录，还是可以直接使用新密码登录？
3. 如果用户正在使用旧密码登录的Token，密码重置后Token何时失效（立即还是下次请求时）？

---

### 🔍 问题 4: 登录历史查询的范围和方式

**位置**: AC-06, Story 4

**问题描述**:
- AC-06 提到"用户查询自己的登录历史"，但没有明确：
  1. 查询接口是否需要分页参数？
  2. 是否需要支持按时间范围筛选？
  3. 是否需要支持按IP地址筛选？
  4. 返回的数据是否需要排序（默认按时间倒序）？
  5. 管理员查看所有用户登录历史的接口是否与本接口相同（通过权限区分）？

**当前状态**: Open Questions 中已提及（第6、7条），但应在业务规则或验收标准中明确

**建议问题**:
1. 登录历史查询接口是否需要支持分页（page, pageSize）？
2. 是否需要支持筛选条件（时间范围、IP地址、设备类型）？
3. 管理员查看所有用户登录历史，是使用同一个接口（通过权限区分），还是单独的接口？
4. 返回结果的默认排序规则是什么（时间倒序）？

---

### 🔍 问题 5: JWT Token 的详细内容

**位置**: AC-03, Data Considerations

**问题描述**:
- Data Considerations 中提到了"JWT Token包含用户ID、过期时间等信息"，但没有明确：
  1. Token中具体包含哪些字段（claims）？
  2. 是否需要包含用户角色、权限等信息？
  3. Token的签名算法是什么（虽然这是技术细节，但在设计阶段需要明确）？

**可能的解释**:
- **最小方案**: 只包含用户ID和过期时间
- **扩展方案**: 包含用户ID、过期时间、角色、权限等

**建议问题**:
1. JWT Token中需要包含哪些claims（用户ID、过期时间、角色、权限等）？
2. Token的签发者（issuer）和受众（audience）是什么？

---

### 🔍 问题 6: 设备标识的获取方式

**位置**: BR-13, Data Considerations

**问题描述**:
- BR-13 要求记录"设备标识（如User-Agent）"，但没有明确：
  1. 设备标识如何获取（从HTTP请求头解析）？
  2. 设备标识的格式要求（是否需要统一格式）？
  3. 移动端和Web端的设备标识获取方式是否不同？
  4. 设备标识是否用于识别同一设备（用于安全检测）？

**可能的解释**:
- **方案A**: 只记录User-Agent字符串
- **方案B**: 解析User-Agent，提取设备类型、操作系统、浏览器等信息
- **方案C**: 生成设备指纹（基于IP、User-Agent等）

**建议问题**:
1. 设备标识是直接存储User-Agent原始字符串，还是需要解析成结构化数据？
2. 移动端（Android/iOS）的设备标识如何获取？
3. 设备标识是否需要用于安全检测（如异常登录检测）？

---

### 🔍 问题 7: 账户状态的管理规则 ✅ 已解决

**位置**: Data Considerations

**解决方案**: 
- 账户状态有启用/禁用/锁定三种状态
- 初始值为启用
- 禁用：管理员手动禁用账户
- 锁定：系统自动锁定（如连续登录失败）
- 账户被锁定后，手动解锁
- 登录时如果账户状态不是"启用"，返回"当前用户存在异常，请联系管理员"

**问题描述**:
- Data Considerations 中提到了"账户状态（启用/禁用/锁定）"，但没有明确：
  1. 账户状态的初始值是什么（默认应该是"启用"）？
  2. 哪些操作会导致账户状态改变？
  3. "禁用"和"锁定"的区别是什么？
  4. 账户被锁定后，如何解锁（自动解锁还是手动解锁）？

**可能的解释**:
- **禁用**: 管理员手动禁用账户
- **锁定**: 系统自动锁定（如连续登录失败）

**建议问题**:
1. 账户状态有哪几种（启用/禁用/锁定）？每种状态的含义是什么？
2. 账户状态的初始值是什么？
3. 账户被锁定后，如何解锁（自动解锁时间、手动解锁方式）？
4. 登录时如果账户状态不是"启用"，应该返回什么错误？

---

### 🔍 问题 8: 验证码存储和管理机制

**位置**: BR-03, BR-05, Data Considerations

**问题描述**:
- 规范中提到了验证码的有效期、使用限制，但没有明确：
  1. 验证码存储在哪里（Redis、数据库）？
  2. 同一手机号可以同时存在多个未使用的验证码吗（如注册验证码和重置验证码）？
  3. 验证码使用后是删除还是标记为已使用？
  4. 如果用户多次请求验证码（在60秒限制内被拒绝），系统应该如何处理？

**可能的解释**:
- **方案A**: 每个手机号同时只能有一个验证码，新验证码覆盖旧验证码
- **方案B**: 不同类型的验证码（注册、重置）可以并存
- **方案C**: 每个验证码有唯一标识，可以并存多个

**建议问题**:
1. 同一手机号的注册验证码和密码重置验证码是否可以同时存在？
2. 验证码存储在哪里（Redis推荐）？
3. 验证码使用后是立即删除，还是保留一段时间用于审计？

---

### 🔍 问题 9: Token刷新机制

**位置**: BR-10

**问题描述**:
- BR-10 说明了JWT Token有效期为7天，但没有明确：
  1. Token过期后，用户是否需要重新登录？
  2. 是否需要提供Token刷新机制（refresh token）？
  3. 如果需要刷新，刷新后的Token有效期是重新计算还是累加？

**可能的解释**:
- **方案A**: Token过期后必须重新登录
- **方案B**: 提供refresh token机制，可以刷新access token

**建议问题**:
1. 是否需要实现Token刷新机制？
2. 如果需要，refresh token的有效期是多少？
3. Token刷新后，旧Token是否立即失效？

---

### 🔍 问题 10: 密码强度验证的详细信息 ✅ 已解决

**位置**: AC-14, BR-07, BR-08

**解决方案**: 
- 密码强度要求：数字+大小写字母+特殊字符
- 密码强度验证失败时，错误信息告知规则是什么即可

**问题描述**:
- BR-08 说明了"密码必须包含至少数字和字母"，AC-14 提到"包含具体要求"，但没有明确：
  1. 密码强度要求的完整规则是什么？
  2. 是否需要包含特殊字符？
  3. 大小写字母是否有要求？
  4. 错误信息中需要包含哪些具体提示？

**可能的解释**:
- **方案A**: 至少包含数字和字母（大小写均可）
- **方案B**: 至少包含数字、小写字母、大写字母
- **方案C**: 至少包含数字、字母、特殊字符

**建议问题**:
1. 密码强度要求的具体规则是什么（数字+字母，还是数字+大小写字母+特殊字符）？
2. 密码强度验证失败时，错误信息需要包含哪些具体提示？

---

### 🔍 问题 11: 登录失败的处理策略

**位置**: AC-15, AC-16, Open Questions

**问题描述**:
- Open Questions 中提到了"账户锁定机制（连续登录失败后锁定）"，但业务规则中没有明确：
  1. 是否需要记录登录失败次数？
  2. 连续失败多少次后锁定账户？
  3. 账户锁定后，多久自动解锁？
  4. 是否需要区分"手机号不存在"和"密码错误"的失败次数（安全考虑）？

**当前状态**: Open Questions 中已提及（第5条），但应在业务规则中明确

**建议问题**:
1. 是否需要实现账户锁定机制？
2. 如果需要，连续失败多少次后锁定？锁定时间是多少？
3. 登录失败次数是否需要记录在登录历史中？

---

### 🔍 问题 12: 短信验证码发送频率的详细规则

**位置**: BR-06, Open Questions

**问题描述**:
- BR-06 说明了"60秒内只能发送一次"，Open Questions 中提到了"每日发送次数限制"，但没有明确：
  1. 60秒限制是针对同一手机号，还是同一IP？
  2. 是否需要限制每日发送次数（防止恶意刷取）？
  3. 如果需要，每日限制是多少次？
  4. 达到限制后，返回什么错误信息？

**当前状态**: Open Questions 中已提及（第10条），但应在业务规则中明确

**建议问题**:
1. 是否需要限制每日发送次数？如果需要，限制是多少次？
2. 60秒限制是针对手机号还是IP地址？
3. 达到限制后，返回什么错误信息？

---

## 2. Business Rules 补充建议

### 📋 缺失的业务规则

以下业务规则在规范中没有明确，建议补充：

1. **账户状态管理规则**
   - 账户状态的初始值（默认"启用"）
   - 状态转换规则（启用→禁用、启用→锁定等）
   - 锁定后的解锁规则

2. **登录失败处理规则**
   - 是否需要记录失败次数
   - 是否需要账户锁定机制
   - 锁定和解锁规则

3. **验证码管理规则**
   - 同一手机号不同类型验证码的并存规则
   - 验证码存储位置和清理规则
   - 每日发送次数限制

4. **Token管理规则**
   - Token刷新机制（如果需要）
   - 多设备登录的Token管理
   - Token失效后的处理

---

## 3. Data Considerations 补充建议

### 📋 数据字段补充

以下数据字段在规范中没有明确，建议补充：

1. **用户表**
   - 创建时间（created_at）
   - 更新时间（updated_at）
   - 登录失败次数（如果实现锁定机制）
   - 账户锁定时间（如果实现锁定机制）
   - 账户锁定原因

2. **验证码表/存储**
   - 验证码类型（注册/重置密码）
   - 验证码使用时间（如果保留审计）
   - 验证码请求IP（安全审计）

3. **登录历史表**
   - 登录是否成功（成功/失败）
   - 登录失败原因（如果记录失败）
   - 登录状态（正常/异常，如果需要）

---

## 4. Edge Cases 补充建议

### 📋 缺失的边界情况

以下边界情况建议补充：

1. **验证码相关**
   - 用户在验证码有效期内多次请求验证码
   - 验证码发送服务临时不可用（已有EC-06，但可以更详细）
   - 用户输入验证码时网络中断

2. **Token相关**
   - Token过期但用户仍在操作（中间操作失败）
   - 多设备登录时的Token冲突
   - Token被恶意使用时的处理

3. **并发相关**
   - 用户同时在不同设备登录
   - 用户同时请求多个验证码（在限制解除的瞬间）
   - 用户同时重置密码和登录（竞态条件）

---

## 5. 优先级建议

### 🔴 高优先级（必须在设计前明确）

1. 验证码发送流程（问题1、2、3）
2. 注册和密码重置的接口设计（问题2、3）
3. 账户状态管理规则（问题7）
4. 密码强度验证规则（问题10）

### 🟡 中优先级（建议在设计前明确）

5. JWT Token的详细内容（问题5）
6. 登录历史查询方式（问题4）
7. Token刷新机制（问题9）
8. 验证码存储机制（问题8）

### 🟢 低优先级（可以在设计阶段明确）

9. 设备标识获取方式（问题6）
10. 登录失败处理策略（问题11）
11. 短信验证码发送频率详细规则（问题12）

---

## 总结

本文档共识别出 **12个主要问题**，涵盖：
- 流程完整性（验证码发送、注册、密码重置）
- 业务规则缺失（账户状态、登录失败处理、Token管理）
- 数据模型不完整（缺少必要的字段定义）
- 接口设计不明确（参数、返回值、错误处理）

### 解决状态

**✅ 已解决（5个）**:
- 问题1: 验证码发送流程
- 问题2: 注册流程的完整性
- 问题3: 密码重置流程的完整性
- 问题7: 账户状态的管理规则
- 问题10: 密码强度验证规则

**⏳ 待解决（7个）**:
- 问题4: 登录历史查询的范围和方式
- 问题5: JWT Token的详细内容
- 问题6: 设备标识的获取方式
- 问题8: 验证码存储和管理机制
- 问题9: Token刷新机制
- 问题11: 登录失败的处理策略
- 问题12: 短信验证码发送频率的详细规则

**建议行动**：
1. ✅ 高优先级问题已解决（验证码流程、账户状态、密码强度）
2. ⏳ 中低优先级问题可在设计阶段进一步明确
3. 📝 已更新规范文档（spec.md v1.1）

---

**下一步**: 
- 如需继续澄清剩余问题，请继续回答
- 如当前规范已满足设计需求，可进入 Phase 2: Design 阶段

